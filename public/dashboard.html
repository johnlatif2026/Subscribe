<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background:#f5f7fa;color:#333;overflow-x:hidden}

    .header{background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.08);padding:1rem 0;position:sticky;top:0;z-index:100;transition:.3s}
    .header-scrolled{padding:.7rem 0;box-shadow:0 6px 20px rgba(0,0,0,.1)}
    .nav-container{max-width:1400px;margin:0 auto;padding:0 20px;display:flex;justify-content:space-between;align-items:center}
    .logo{font-size:1.5rem;font-weight:700;color:#764ba2;display:flex;align-items:center;transition:.3s}
    .logo:hover{transform:scale(1.05)}
    .logo i{margin-left:10px;font-size:1.3rem}
    .user-menu{display:flex;align-items:center;gap:1.5rem}
    .user-menu span{color:#555;font-weight:500}

    .btn{
      background:linear-gradient(to left,#667eea,#764ba2);
      color:#fff;padding:.6rem 1.2rem;border:0;border-radius:8px;cursor:pointer;
      transition:.3s;font-weight:600;box-shadow:0 4px 10px rgba(118,75,162,.2);
      position:relative;overflow:hidden
    }
    .btn:hover{transform:translateY(-3px);box-shadow:0 6px 15px rgba(118,75,162,.3)}
    .btn:active{transform:translateY(-1px)}
    .btn-success{background:linear-gradient(to left,#28a745,#20c997)}
    .btn-danger{background:linear-gradient(to left,#dc3545,#e83e8c)}

    .container{max-width:1400px;margin:2rem auto;padding:0 20px}

    .stats-section{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:1.5rem;margin-bottom:2.5rem
    }
    .stat-card{
      background:#fff;border-radius:12px;padding:1.8rem;text-align:center;
      box-shadow:0 5px 15px rgba(0,0,0,.06);transition:.4s;border-top:4px solid transparent
    }
    .stat-card:nth-child(1){border-top-color:#667eea}
    .stat-card:nth-child(2){border-top-color:#ffc107}
    .stat-card:nth-child(3){border-top-color:#28a745}
    .stat-card:nth-child(4){border-top-color:#dc3545}
    .stat-card:hover{transform:translateY(-8px);box-shadow:0 12px 25px rgba(0,0,0,.1)}

    .stat-number{font-size:2.5rem;font-weight:800;color:#764ba2;margin-bottom:.5rem}
    .stat-label{color:#666;font-size:.95rem;font-weight:600}

    .orders-section{background:#fff;border-radius:15px;padding:2.5rem;box-shadow:0 8px 25px rgba(0,0,0,.08)}
    .section-title{
      margin-bottom:1.5rem;color:#333;border-bottom:2px solid #f0f0f0;padding-bottom:1rem;
      display:flex;justify-content:space-between;align-items:center;gap:12px
    }
    .section-title h2{font-size:1.5rem}

    .refresh-btn{
      background:linear-gradient(to left,#17a2b8,#6f42c1);
      color:#fff;border:0;padding:.6rem 1.2rem;border-radius:8px;cursor:pointer;
      font-weight:700;transition:.3s;display:flex;align-items:center;gap:8px
    }
    .refresh-btn:hover{transform:translateY(-3px)}

    /* âœ… Wrapper Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù„Ø´Ø§Ù† Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    .table-wrap{
      width:100%;
      overflow:auto;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,.04);
      -webkit-overflow-scrolling: touch;
      margin-top: 1rem;
    }

    /* âœ… ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„ + Ù…Ù†Ø¹ Ø®Ø±ÙˆØ¬ Ø§Ù„ÙƒÙ„Ø§Ù… */
    .orders-table{
      width:100%;
      min-width:1250px;
      border-collapse:separate;
      border-spacing:0;
      background:#fff;
    }

    .orders-table th,.orders-table td{
      padding:12px 14px;
      text-align:right;
      border-bottom:1px solid #f0f0f0;
      vertical-align:top;

      /* âœ… Ø£Ù‡Ù… Ø¬Ø²Ø¡: Ø®Ù„ÙŠ Ø§Ù„ÙƒÙ„Ø§Ù… ÙŠÙ„Ù */
      white-space: normal;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .orders-table th{
      background:#f8f9fa;
      font-weight:800;
      position:sticky;
      top:0;
      z-index:2;
    }
    .orders-table tr:hover{background:#fafafa}

    /* âœ… Ø³ØªØ§ØªØ³ */
    .status-pending{background:#fff3cd;color:#856404;padding:.35rem .75rem;border-radius:20px;font-size:.85rem;font-weight:800;display:inline-block}
    .status-completed{background:#d1edff;color:#004085;padding:.35rem .75rem;border-radius:20px;font-size:.85rem;font-weight:800;display:inline-block}
    .status-cancelled{background:#f8d7da;color:#721c24;padding:.35rem .75rem;border-radius:20px;font-size:.85rem;font-weight:800;display:inline-block}

    .loading{text-align:center;padding:2.5rem;color:#666;font-size:1.1rem}

    /* âœ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª */
    .action-buttons{
      display:flex;
      gap:8px;
      justify-content:flex-start;
      flex-wrap:wrap;
      min-width:150px;
    }
    .action-buttons .btn{padding:.45rem .9rem;font-size:.85rem;border-radius:10px}

    /* âœ… Ø±Ø³Ø§Ø¦Ù„ */
    .message{margin-top:1.5rem;padding:1rem;border-radius:8px;text-align:center;display:none}
    .success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}

    /* âœ… Ellipsis Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù„ÙŠ Ø¨ØªØ·ÙˆÙ„ */
    .cell-ellipsis{
      max-width:220px;
      white-space:nowrap !important;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .cell-ellipsis.sm{max-width:140px}
    .cell-ellipsis.md{max-width:220px}
    .cell-ellipsis.lg{max-width:320px}

    /* âœ… Ø³Ø·Ø±ÙŠÙ† Ø¨Ø§Ù„ÙƒØªÙŠØ± */
    .cell-clamp-2{
      max-width:260px;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    /* âœ… Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙƒØ±ÙŠÙ† */
    .screenshot-link{
      color:#764ba2;
      font-weight:800;
      text-decoration:underline;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .screenshot-link::before{content:"ğŸ–¼ï¸"}

    /* âœ… Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© */
    .image-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);justify-content:center;align-items:center;z-index:2000}
    .image-modal.active{display:flex}
    .image-modal-content{max-width:92%;max-height:92%;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .image-modal-close{
      position:absolute;top:20px;left:20px;color:#fff;font-size:2rem;cursor:pointer;
      background:rgba(0,0,0,.5);width:42px;height:42px;border-radius:50%;
      display:flex;align-items:center;justify-content:center
    }

    @media (max-width:768px){
      .orders-section{padding:1.2rem}
      .stats-section{grid-template-columns:1fr}
      .section-title{flex-direction:column;align-items:flex-start}
      .orders-table{min-width:1100px}
    }
  </style>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

  <div id="imageModal" class="image-modal">
    <span class="image-modal-close" id="closeImageModal">&times;</span>
    <img id="modalImage" class="image-modal-content" src="" alt="Ø³ÙƒØ±ÙŠÙ† Ø§Ù„ØªØ­ÙˆÙŠÙ„">
  </div>

  <header class="header" id="mainHeader">
    <div class="nav-container">
      <div class="logo"><i class="fas fa-tachometer-alt"></i> Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
      <div class="user-menu">
        <span>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø§Ù„Ø£Ø¯Ù…Ù†</span>
        <button id="logoutBtn" class="btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="stats-section">
      <div class="stat-card"><div class="stat-number" id="totalOrders">0</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div></div>
      <div class="stat-card"><div class="stat-number" id="pendingOrders">0</div><div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div></div>
      <div class="stat-card"><div class="stat-number" id="completedOrders">0</div><div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</div></div>
      <div class="stat-card"><div class="stat-number" id="cancelledOrders">0</div><div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ù…Ù„ØºØ§Ø©</div></div>
    </div>

    <div class="orders-section">
      <div class="section-title">
        <h2>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h2>
        <button id="refreshBtn" class="refresh-btn"><i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«</button>
      </div>

      <!-- âœ… Wrapper -->
      <div class="table-wrap">
        <table class="orders-table">
          <thead>
            <tr>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
              <th>Ø§Ù„Ù…Ù†ØµØ©</th>
              <th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</th>
              <th>Ø§Ù„Ø¨Ø§Ù‚Ø©</th>
              <th>Ø§Ù„Ù…Ø¯Ø©</th>
              <th>Ø³Ø¹Ø± Ø§Ù„Ø¨Ø§Ù‚Ø©</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</th>
              <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
              <th>Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„</th>
              <th>Ø³ÙƒØ±ÙŠÙ† Ø§Ù„ØªØ­ÙˆÙŠÙ„</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody">
            <tr><td colspan="14" class="loading"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</td></tr>
          </tbody>
        </table>
      </div>

      <div id="message" class="message"></div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const ordersTableBody = document.getElementById('ordersTableBody');
  const refreshBtn = document.getElementById('refreshBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const messageEl = document.getElementById('message');
  const header = document.getElementById('mainHeader');

  const imageModal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');
  const closeImageModal = document.getElementById('closeImageModal');

  window.addEventListener('scroll', function() {
    if (window.scrollY > 20) header.classList.add('header-scrolled');
    else header.classList.remove('header-scrolled');
  });

  const getCsrfToken = () => {
    return document.cookie.split('; ')
      .find(r => r.startsWith('XSRF-TOKEN='))
      ?.split('=')[1];
  };

  function extractFilename(pathOrUrl) {
    if (!pathOrUrl) return null;
    const parts = String(pathOrUrl).split('/');
    return parts[parts.length - 1] || null;
  }

  function getSecureScreenshotUrl(transferScreenshotField) {
    const filename = extractFilename(transferScreenshotField);
    if (!filename) return null;
    return `/api/screenshot/${encodeURIComponent(filename)}`;
  }

  function getStatusText(status) {
    const map = { pending: 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', completed: 'Ù…ÙƒØªÙ…Ù„', cancelled: 'Ù…Ù„ØºÙ‰' };
    return map[status] || 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
  }

  async function loadOrders() {
    try {
      const res = await fetch('/api/orders', { credentials: 'include' });
      if (res.status === 401) { window.location.href = '/login.html'; return; }
      const orders = await res.json();
      displayOrders(Array.isArray(orders) ? orders : []);
      updateStats(Array.isArray(orders) ? orders : []);
    } catch (e) {
      console.error(e);
      ordersTableBody.innerHTML = `<tr><td colspan="14" class="loading"><i class="fas fa-exclamation-triangle"></i> Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</td></tr>`;
    }
  }

  function displayOrders(orders) {
    if (!orders.length) {
      ordersTableBody.innerHTML = `<tr><td colspan="14" class="loading"><i class="fas fa-inbox"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>`;
      return;
    }

    ordersTableBody.innerHTML = '';

    orders.forEach(order => {
      const row = document.createElement('tr');

      const statusClass = `status-${order.status || 'pending'}`;
      const statusText = getStatusText(order.status);

      const basePrice = (order.basePrice ?? 'â€”');
      const planName = (order.planName ?? 'â€”');
      const planDuration = (order.planDuration ?? 'â€”');
      const planPrice = (order.planPrice ?? 'â€”');

      const date = order.createdAt ? new Date(order.createdAt).toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

      const secureScreenshotUrl = getSecureScreenshotUrl(order.transferScreenshot);
      const screenshotLink = secureScreenshotUrl
        ? `<span class="screenshot-link" onclick="showImage('${secureScreenshotUrl}')">Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙƒØ±ÙŠÙ†</span>`
        : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';

      row.innerHTML = `
        <td class="cell-ellipsis sm" title="${String(order.id || '')}">${String(order.id || '').substring(0, 8)}...</td>
        <td class="cell-ellipsis md" title="${order.subscriptionName || ''}">${order.subscriptionName || 'â€”'}</td>
        <td>${basePrice} Ø¬Ù†ÙŠÙ‡</td>
        <td class="cell-clamp-2" title="${planName || ''}">${planName}</td>
        <td class="cell-ellipsis sm" title="${planDuration || ''}">${planDuration}</td>
        <td>${planPrice} Ø¬Ù†ÙŠÙ‡</td>
        <td class="cell-ellipsis md" title="${order.accountName || ''}">${order.accountName || 'â€”'}</td>
        <td class="cell-ellipsis lg" title="${order.email || ''}">${order.email || 'â€”'}</td>
        <td class="cell-ellipsis md" title="${order.phone || ''}">${order.phone || 'â€”'}</td>
        <td class="cell-ellipsis sm" title="${order.transferNumber || ''}">${order.transferNumber || 'â€”'}</td>
        <td>${screenshotLink}</td>
        <td><span class="${statusClass}">${statusText}</span></td>
        <td class="cell-ellipsis md" title="${date}">${date}</td>
        <td>
          <div class="action-buttons">
            ${order.status !== 'completed' ? `<button class="btn btn-success" onclick="updateOrderStatus('${order.id}', 'completed')">Ø¥ÙƒÙ…Ø§Ù„</button>` : ''}
            ${order.status !== 'cancelled' ? `<button class="btn btn-danger" onclick="updateOrderStatus('${order.id}', 'cancelled')">Ø¥Ù„ØºØ§Ø¡</button>` : ''}
          </div>
        </td>
      `;

      ordersTableBody.appendChild(row);
    });
  }

  function updateStats(orders) {
    document.getElementById('totalOrders').textContent = orders.length;
    document.getElementById('pendingOrders').textContent = orders.filter(o => (o.status || 'pending') === 'pending').length;
    document.getElementById('completedOrders').textContent = orders.filter(o => o.status === 'completed').length;
    document.getElementById('cancelledOrders').textContent = orders.filter(o => o.status === 'cancelled').length;
  }

  window.showImage = function(url) {
    modalImage.src = url;
    imageModal.classList.add('active');
  };

  closeImageModal.addEventListener('click', function() {
    imageModal.classList.remove('active');
    modalImage.src = '';
  });

  imageModal.addEventListener('click', function(e) {
    if (e.target === imageModal) {
      imageModal.classList.remove('active');
      modalImage.src = '';
    }
  });

  window.updateOrderStatus = async function(orderId, status) {
    try {
      const csrfToken = getCsrfToken();
      const res = await fetch(`/api/orders/${orderId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ status, _csrf: csrfToken })
      });

      const result = await res.json();

      if (result.success) {
        messageEl.textContent = 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­';
        messageEl.className = 'message success';
        messageEl.style.display = 'block';
        loadOrders();
        setTimeout(() => messageEl.style.display = 'none', 2500);
      } else {
        messageEl.textContent = result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©';
        messageEl.className = 'message error';
        messageEl.style.display = 'block';
      }
    } catch (e) {
      console.error(e);
      messageEl.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©';
      messageEl.className = 'message error';
      messageEl.style.display = 'block';
    }
  };

  refreshBtn.addEventListener('click', function() {
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ØªØ­Ø¯ÙŠØ«';
    loadOrders();
    setTimeout(() => refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«', 900);
  });

  logoutBtn.addEventListener('click', async function() {
    try {
      await fetch('/api/admin/logout', { method: 'POST', credentials: 'include' });
      window.location.href = '/login.html';
    } catch (e) { console.error(e); }
  });

  loadOrders();
  setInterval(loadOrders, 30000);
});
</script>

</body>
</html>
